<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Barberia APOLO</title>

    <link rel="stylesheet" href="../css/style.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aileron:wght@300;400;700&family=Montserrat:wght@400;700&family=Pinyon+Script&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- COLORES DE ESTADO --- */
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }
        .status.pendiente { 
            background-color: rgba(241, 196, 15, 0.15); 
            color: #f1c40f; 
            border: 1px solid rgba(241, 196, 15, 0.3);
        }
        .status.confirmada { 
            background-color: rgba(46, 204, 113, 0.15); 
            color: #2ecc71; 
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .status.completada { 
            background-color: rgba(52, 152, 219, 0.15); 
            color: #3498db; 
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
    </style>
</head>
<body class="pagina-interna">

    <header class="main-header header-interno">
        <div class="logo-admin">
            <img src="../images/imgLogo.png" alt="Logo">
            <span>PANEL ADMINISTRATIVO</span>
        </div>
        
        <nav class="main-nav">
            <ul>
                <li><a href="#" class="active"><i class="fas fa-home"></i> Inicio</a></li>
                <li><a href="intAgenda.html"><i class="fas fa-calendar-alt"></i> Agenda</a></li>
                <li><a href="intVentas.html"><i class="fas fa-cash-register"></i> Caja</a></li>
                <li><a href="intGastos.html"><i class="fas fa-wallet"></i> Gastos</a></li>
                <li><a href="intReportes.html"><i class="fas fa-chart-line"></i> Reportes</a></li>
                <li><a href="#" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Salir</a></li>
            </ul>
        </nav>
    </header>

    <section class="dashboard-section">
        
        <div class="dashboard-header">
            <h1>Hola, Apolo Barber</h1>
            <p>Resumen de operaciones del día: <strong id="fecha-hoy-texto" style="color: #f39c12;"></strong></p>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="kpi-info">
                    <h3>Citas Hoy</h3>
                    <span class="kpi-value" id="kpi-citas-hoy">...</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="kpi-info">
                    <h3>Ventas del Día</h3>
                    <span class="kpi-value" id="kpi-ventas-hoy">$0.00</span> 
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon"><i class="fas fa-cut"></i></div>
                <div class="kpi-info">
                    <h3>Servicios Realizados</h3>
                    <span class="kpi-value" id="kpi-servicios-realizados">0</span>
                </div>
            </div>
        </div>

        <h2 class="section-subtitle">Acciones Rápidas</h2>
        <div class="actions-grid">
            <a href="intAgenda.html" class="action-card">
                <i class="fas fa-calendar-plus"></i>
                <span>Nueva Cita</span>
            </a>
            <a href="intVentas.html" class="action-card">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Registrar Venta</span>
            </a>
            <a href="intGastos.html" class="action-card">
                <i class="fas fa-wallet"></i>
                <span>Registrar Gasto</span>
            </a>
            <a href="intReportes.html" class="action-card">
                <i class="fas fa-chart-line"></i>
                <span>Ver Reportes</span>
            </a>
        </div>

        <div class="recent-activity">
            <div class="table-header">
                <h2>Citas para Hoy</h2>
                <a href="intAgenda.html" class="view-all">Ver Agenda Completa</a>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-citas-body">
                        <tr>
                            <td colspan="4" style="text-align:center;">Cargando citas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </section>

    <script type="module">
        import { db, verificarSesion, cerrarSesion } from "../js/firebase.js";
        import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        verificarSesion();

        const btnSalir = document.querySelector('.logout-btn');
        if(btnSalir) {
            btnSalir.addEventListener('click', (e) => {
                e.preventDefault();
                cerrarSesion();
            });
        }

        // Fecha Bonita
        const fechaElemento = document.getElementById('fecha-hoy-texto');
        const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const fechaActualTexto = new Date().toLocaleDateString('es-ES', opciones);
        fechaElemento.textContent = fechaActualTexto.charAt(0).toUpperCase() + fechaActualTexto.slice(1);

        // --- CARGAR DASHBOARD COMPLETO ---
        async function cargarDashboard() {
            // Fecha YYYY-MM-DD local
            const hoy = new Date();
            const fechaQuery = hoy.toLocaleDateString('en-CA'); 

            console.log("Analizando día:", fechaQuery);

            try {
                // --------------------------------------------------
                // 1. CONSULTAR CITAS (Agenda)
                // --------------------------------------------------
                const citasRef = collection(db, "agenda");
                const qCitas = query(
                    citasRef, 
                    where("fecha", "==", fechaQuery),
                    orderBy("hora", "asc")
                );

                const snapCitas = await getDocs(qCitas);

                // A. KPI: Total de Citas
                const cantidadTotal = snapCitas.size;
                document.getElementById('kpi-citas-hoy').innerText = cantidadTotal;

                // B. KPI: Servicios Realizados
                let serviciosCompletados = 0;

                // C. Tabla
                const tablaBody = document.getElementById('tabla-citas-body');
                tablaBody.innerHTML = ""; 

                if (cantidadTotal === 0) {
                    tablaBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color: #c0c0c0;">No hay citas programadas para hoy.</td></tr>`;
                } else {
                    snapCitas.forEach((doc) => {
                        const cita = doc.data();
                        
                        let claseEstado = "pendiente"; 
                        if (cita.estado === "confirmada") {
                            claseEstado = "confirmada";
                        } else if (cita.estado === "completada") {
                            claseEstado = "completada";
                            serviciosCompletados++; // Contamos completadas
                        }
                        
                        const fila = `
                            <tr>
                                <td style="font-weight:bold; color:#f39c12;">${convertirHora(cita.hora)}</td>
                                <td>${cita.cliente}</td>
                                <td>${cita.servicio}</td>
                                <td><span class="status ${claseEstado}">${cita.estado.toUpperCase()}</span></td>
                            </tr>
                        `;
                        tablaBody.innerHTML += fila;
                    });
                }
                document.getElementById('kpi-servicios-realizados').innerText = serviciosCompletados;


                // --------------------------------------------------
                // 2. CONSULTAR VENTAS DEL DÍA (Nueva Conexión)
                // --------------------------------------------------
                const ventasRef = collection(db, "ventas");
                const qVentas = query(ventasRef, where("fecha", "==", fechaQuery));
                
                const snapVentas = await getDocs(qVentas);
                
                let totalVentasDia = 0;
                snapVentas.forEach(doc => {
                    const venta = doc.data();
                    // Sumamos el campo 'total' de cada venta
                    totalVentasDia += Number(venta.total);
                });

                // Actualizamos el KPI con formato de moneda
                document.getElementById('kpi-ventas-hoy').innerText = formatMoney(totalVentasDia);


            } catch (error) {
                console.error("Error al cargar el dashboard:", error);
            }
        }

        // Auxiliar: Hora bonita (13:00 -> 01:00 PM)
        function convertirHora(hora24) {
            const [h, m] = hora24.split(':');
            let horas = parseInt(h);
            const ampm = horas >= 12 ? 'PM' : 'AM';
            horas = horas % 12;
            horas = horas ? horas : 12; 
            return `${horas}:${m} ${ampm}`;
        }

        // Auxiliar: Dinero ($1,200.00)
        function formatMoney(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }

        cargarDashboard();

    </script>

</body>
</html>