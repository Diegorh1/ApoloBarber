<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Gastos - Barberia APOLO</title>

    <link rel="stylesheet" href="../css/style.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aileron:wght@300;400;700&family=Montserrat:wght@400;700&family=Pinyon+Script&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="pagina-interna">

    <header class="main-header header-interno">
        <div class="logo-admin">
            <img src="../images/imgLogo.png" alt="Logo">
            <span>PANEL ADMINISTRATIVO</span>
        </div>
        
        <nav class="main-nav">
            <ul>
                <li><a href="intPanelControl.html"><i class="fas fa-home"></i> Inicio</a></li>
                <li><a href="intAgenda.html"><i class="fas fa-calendar-alt"></i> Agenda</a></li>
                <li><a href="intVentas.html"><i class="fas fa-cash-register"></i> Caja</a></li>
                <li><a href="#" class="active"><i class="fas fa-wallet"></i> Gastos</a></li>
                <li><a href="#" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Salir</a></li>
            </ul>
        </nav>
    </header>

    <section class="admin-section">
        <div class="admin-container">
            
            <div class="page-header">
                <h1>Registro de Egresos</h1>
                <div class="date-display">
                    <i class="fas fa-wallet"></i> Control Financiero
                </div>
            </div>

            <div class="gastos-layout">
                
                <div class="gastos-form-card">
                    <h2 class="card-title"><i class="fas fa-plus-circle"></i> Nuevo Gasto</h2>
                    
                    <form id="expenseForm">
                        
                        <div class="form-group">
                            <label>Concepto / Descripción</label>
                            <input type="text" id="desc-gasto" class="admin-input" placeholder="Ej. Pago de luz, Compra de toallas..." required>
                        </div>

                        <div class="form-row-2">
                            <div class="form-group">
                                <label>Categoría</label>
                                <select id="cat-gasto" class="admin-input">
                                    <option value="servicios">Servicios Básicos (Luz/Agua)</option>
                                    <option value="insumos">Insumos / Inventario</option>
                                    <option value="mantenimiento">Mantenimiento</option>
                                    <option value="sueldos">Sueldos / Comisiones</option>
                                    <option value="publicidad">Publicidad</option>
                                    <option value="otros">Otros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Monto ($)</label>
                                <input type="number" id="monto-gasto" class="admin-input" placeholder="0.00" min="0" step="0.01" required>
                            </div>
                        </div>

                        <div class="form-row-2">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" class="admin-input" id="expense-date" required>
                            </div>
                            <div class="form-group">
                                <label>Método de Pago</label>
                                <select id="metodo-gasto" class="admin-input">
                                    <option value="efectivo">Efectivo (Caja)</option>
                                    <option value="transferencia">Transferencia</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Notas Adicionales</label>
                            <textarea id="notas-gasto" class="admin-input" rows="3" placeholder="Detalles adicionales..."></textarea>
                        </div>

                        <button type="submit" class="btn-cta full-width">
                            <i class="fas fa-save"></i> Registrar Gasto
                        </button>

                    </form>
                </div>

                <div class="gastos-history-panel">
                    <div class="history-header">
                        <h2>Últimos Movimientos</h2>
                        <span class="total-expenses">Total: <b style="color: #e74c3c;" id="total-display">$0.00</b></span>
                    </div>

                    <div class="table-responsive">
                        <table class="table-gastos">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Categoría</th>
                                    <th>Monto</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tabla-gastos-body">
                                <tr><td colspan="5" style="text-align:center">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>
    </section>

    <script type="module">
        import { db, verificarSesion, cerrarSesion } from "../js/firebase.js";
        import { collection, addDoc, query, orderBy, getDocs, deleteDoc, doc, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 1. Seguridad
        verificarSesion();
        const btnSalir = document.querySelector('.logout-btn');
        if(btnSalir) btnSalir.addEventListener('click', (e) => { e.preventDefault(); cerrarSesion(); });

        // 2. Fecha por defecto
        const dateInput = document.getElementById('expense-date');
        dateInput.valueAsDate = new Date();

        // 3. GUARDAR GASTO
        const form = document.getElementById('expenseForm');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const desc = document.getElementById('desc-gasto').value;
            const cat = document.getElementById('cat-gasto').value;
            const monto = parseFloat(document.getElementById('monto-gasto').value);
            const fecha = document.getElementById('expense-date').value;
            const metodo = document.getElementById('metodo-gasto').value;
            const notas = document.getElementById('notas-gasto').value;
            const btn = form.querySelector('button');

            try {
                btn.innerText = "Guardando...";
                btn.disabled = true;

                // Guardar en colección 'gastos'
                await addDoc(collection(db, "gastos"), {
                    descripcion: desc,
                    categoria: cat,
                    monto: monto,
                    fecha: fecha,
                    metodo: metodo,
                    notas: notas,
                    creado: new Date()
                });

                alert("Gasto registrado correctamente");
                form.reset();
                dateInput.valueAsDate = new Date();
                cargarGastos(); // Recargar tabla

            } catch (error) {
                console.error("Error:", error);
                alert("Error al guardar.");
            } finally {
                btn.innerHTML = '<i class="fas fa-save"></i> Registrar Gasto';
                btn.disabled = false;
            }
        });

        // 4. CARGAR TABLA Y CALCULAR TOTAL
        async function cargarGastos() {
            const tbody = document.getElementById('tabla-gastos-body');
            const totalDisplay = document.getElementById('total-display');
            
            try {
                // Ordenar por fecha descendente (lo nuevo arriba)
                const q = query(collection(db, "gastos"), orderBy("fecha", "desc"), limit(50));
                const snapshot = await getDocs(q);

                let totalSuma = 0;
                let html = "";

                if(snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666;">No hay gastos registrados.</td></tr>';
                    totalDisplay.innerText = "$0.00";
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalSuma += Number(data.monto);

                    // Colores para las categorías
                    let badgeClass = "badge-cat ";
                    if(data.categoria === 'servicios') badgeClass += "servicios";
                    else if(data.categoria === 'insumos') badgeClass += "insumos";
                    else if(data.categoria === 'mantenimiento') badgeClass += "mtto";
                    else if(data.categoria === 'publicidad') badgeClass += "ads";
                    else badgeClass += "otros";

                    html += `
                        <tr>
                            <td>${formatearFecha(data.fecha)}</td>
                            <td>${data.descripcion} <br><small style="color:#666;">${data.metodo}</small></td>
                            <td><span class="${badgeClass}">${data.categoria.toUpperCase()}</span></td>
                            <td class="amount-negative">-$${data.monto.toFixed(2)}</td>
                            <td>
                                <button onclick="eliminarGasto('${doc.id}')" style="background:none; border:none; color:#666; cursor:pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
                totalDisplay.innerText = `$${totalSuma.toFixed(2)}`;

            } catch (error) {
                console.error(error);
            }
        }

        // 5. ELIMINAR GASTO
        window.eliminarGasto = async function(id) {
            if(confirm("¿Eliminar este registro?")) {
                try {
                    await deleteDoc(doc(db, "gastos", id));
                    cargarGastos();
                } catch (e) { console.error(e); }
            }
        }

        function formatearFecha(fechaStr) {
            const partes = fechaStr.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        cargarGastos();

    </script>

</body>
</html>